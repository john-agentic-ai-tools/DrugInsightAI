<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
    xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
    http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.1.xsd">

    <changeSet id="006-001-create-adverse-events-table" author="druginsightai">
        <comment>Create adverse events table</comment>
        <createTable tableName="adverse_events">
            <column name="id" type="uuid" defaultValueComputed="uuid_generate_v4()">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="drug_id" type="uuid">
                <constraints nullable="false" foreignKeyName="fk_adverse_events_drug" references="drugs(id)" deleteCascade="true"/>
            </column>
            <column name="case_id" type="varchar(100)">
                <constraints nullable="false"/>
            </column>
            <column name="preferred_term" type="varchar(200)">
                <constraints nullable="false"/>
            </column>
            <column name="system_organ_class" type="varchar(200)"/>
            <column name="high_level_term" type="varchar(200)"/>
            <column name="severity" type="adverse_event_severity">
                <constraints nullable="false"/>
            </column>
            <column name="outcome" type="adverse_event_outcome">
                <constraints nullable="false"/>
            </column>
            <column name="seriousness" type="boolean" defaultValue="false">
                <constraints nullable="false"/>
            </column>
            <column name="source" type="adverse_event_source">
                <constraints nullable="false"/>
            </column>
            <column name="report_date" type="date">
                <constraints nullable="false"/>
            </column>
            <column name="event_date" type="date"/>
            <column name="patient_age" type="integer"/>
            <column name="patient_age_group" type="age_group"/>
            <column name="patient_gender" type="gender"/>
            <column name="patient_weight" type="decimal(5,2)"/>
            <column name="medical_history" type="text[]"/>
            <column name="indication" type="varchar(200)"/>
            <column name="dosage" type="varchar(200)"/>
            <column name="route" type="varchar(100)"/>
            <column name="therapy_start_date" type="date"/>
            <column name="therapy_end_date" type="date"/>
            <column name="therapy_duration_days" type="integer"/>
            <column name="rechallenge" type="boolean"/>
            <column name="dechallenge" type="boolean"/>
            <column name="concomitant_drugs" type="jsonb"/>
            <column name="reporter_qualification" type="reporter_qualification"/>
            <column name="reporter_country" type="varchar(100)"/>
            <column name="regulatory_submission_date" type="date"/>
            <column name="regulatory_number" type="varchar(100)"/>
            <column name="expedited_report" type="boolean" defaultValue="false"/>
            <column name="follow_up_number" type="integer"/>
            <column name="created_at" type="timestamp" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="updated_at" type="timestamp" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>

    <changeSet id="006-002-create-meddra-terms-table" author="druginsightai">
        <comment>Create MedDRA terms reference table</comment>
        <createTable tableName="meddra_terms">
            <column name="id" type="uuid" defaultValueComputed="uuid_generate_v4()">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="code" type="varchar(20)">
                <constraints nullable="false" unique="true"/>
            </column>
            <column name="preferred_term" type="varchar(200)">
                <constraints nullable="false"/>
            </column>
            <column name="high_level_term" type="varchar(200)"/>
            <column name="high_level_group_term" type="varchar(200)"/>
            <column name="system_organ_class" type="varchar(200)">
                <constraints nullable="false"/>
            </column>
            <column name="level" type="varchar(10)">
                <constraints nullable="false"/>
            </column>
            <column name="parent_code" type="varchar(20)"/>
            <column name="is_active" type="boolean" defaultValue="true">
                <constraints nullable="false"/>
            </column>
            <column name="version" type="varchar(10)"/>
            <column name="created_at" type="timestamp" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="updated_at" type="timestamp" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>

    <changeSet id="006-003-create-adverse-event-summaries-table" author="druginsightai">
        <comment>Create adverse event summaries table for pre-calculated statistics</comment>
        <createTable tableName="adverse_event_summaries">
            <column name="id" type="uuid" defaultValueComputed="uuid_generate_v4()">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="drug_id" type="uuid">
                <constraints nullable="false" foreignKeyName="fk_ae_summaries_drug" references="drugs(id)" deleteCascade="true"/>
            </column>
            <column name="period_start" type="date">
                <constraints nullable="false"/>
            </column>
            <column name="period_end" type="date">
                <constraints nullable="false"/>
            </column>
            <column name="total_reports" type="integer" defaultValue="0">
                <constraints nullable="false"/>
            </column>
            <column name="by_severity" type="jsonb"/>
            <column name="by_outcome" type="jsonb"/>
            <column name="by_system_organ_class" type="jsonb"/>
            <column name="top_preferred_terms" type="jsonb"/>
            <column name="by_age_group" type="jsonb"/>
            <column name="by_gender" type="jsonb"/>
            <column name="by_source" type="jsonb"/>
            <column name="reporting_trends" type="jsonb"/>
            <column name="last_calculated" type="timestamp" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="created_at" type="timestamp" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="updated_at" type="timestamp" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>

</databaseChangeLog>
