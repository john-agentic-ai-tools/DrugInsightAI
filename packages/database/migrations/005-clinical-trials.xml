<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
    xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
    http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.1.xsd">

    <changeSet id="005-001-create-clinical-trials-table" author="druginsightai">
        <comment>Create clinical trials table</comment>
        <createTable tableName="clinical_trials">
            <column name="id" type="uuid" defaultValueComputed="uuid_generate_v4()">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="nct_id" type="varchar(50)">
                <constraints nullable="false" unique="true"/>
            </column>
            <column name="title" type="text">
                <constraints nullable="false"/>
            </column>
            <column name="phase" type="trial_phase">
                <constraints nullable="false"/>
            </column>
            <column name="status" type="trial_status">
                <constraints nullable="false"/>
            </column>
            <column name="sponsor" type="varchar(200)">
                <constraints nullable="false"/>
            </column>
            <column name="drug_id" type="uuid">
                <constraints nullable="true" foreignKeyName="fk_trials_drug" references="drugs(id)"/>
            </column>
            <column name="drug_name" type="varchar(200)"/>
            <column name="indication" type="text"/>
            <column name="description" type="text"/>
            <column name="enrollment_target" type="integer"/>
            <column name="enrollment_actual" type="integer"/>
            <column name="start_date" type="date"/>
            <column name="completion_date" type="date"/>
            <column name="primary_completion_date" type="date"/>
            <column name="locations" type="text[]"/>
            <column name="primary_endpoints" type="text[]"/>
            <column name="secondary_endpoints" type="text[]"/>
            <column name="inclusion_criteria" type="text[]"/>
            <column name="exclusion_criteria" type="text[]"/>
            <column name="is_active" type="boolean" defaultValue="true">
                <constraints nullable="false"/>
            </column>
            <column name="created_at" type="timestamp" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="updated_at" type="timestamp" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>

    <changeSet id="005-002-create-trial-investigators-table" author="druginsightai">
        <comment>Create trial investigators table</comment>
        <createTable tableName="trial_investigators">
            <column name="id" type="uuid" defaultValueComputed="uuid_generate_v4()">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="trial_id" type="uuid">
                <constraints nullable="false" foreignKeyName="fk_investigators_trial" references="clinical_trials(id)" deleteCascade="true"/>
            </column>
            <column name="name" type="varchar(200)">
                <constraints nullable="false"/>
            </column>
            <column name="institution" type="varchar(200)">
                <constraints nullable="false"/>
            </column>
            <column name="role" type="varchar(100)"/>
            <column name="email" type="varchar(255)"/>
            <column name="phone" type="varchar(50)"/>
            <column name="country" type="varchar(100)"/>
            <column name="city" type="varchar(100)"/>
            <column name="created_at" type="timestamp" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="updated_at" type="timestamp" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>

    <changeSet id="005-003-create-trial-results-table" author="druginsightai">
        <comment>Create trial results table</comment>
        <createTable tableName="trial_results">
            <column name="id" type="uuid" defaultValueComputed="uuid_generate_v4()">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="trial_id" type="uuid">
                <constraints nullable="false" foreignKeyName="fk_results_trial" references="clinical_trials(id)" deleteCascade="true"/>
            </column>
            <column name="primary_outcome" type="jsonb"/>
            <column name="secondary_outcomes" type="jsonb"/>
            <column name="safety_results" type="jsonb"/>
            <column name="efficacy_results" type="jsonb"/>
            <column name="statistical_analysis" type="jsonb"/>
            <column name="conclusions" type="text"/>
            <column name="publication_date" type="date"/>
            <column name="publication_reference" type="text"/>
            <column name="data_quality_score" type="decimal(3,2)"/>
            <column name="created_at" type="timestamp" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="updated_at" type="timestamp" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>

</databaseChangeLog>
